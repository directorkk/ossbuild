#summary Compilation on Mac OSX.

Compilation of GStreamer for the Mac platform is in its earlier stages. [http://www.macports.org/ MacPorts] is currently used as the mechanism to resolve dependencies, apply patches and build the binaries. This is followed by some post-build steps to remove absolute paths in the resulting _.dylib_ and _.so_ files (which !MacPorts sets by default to /opt/local/lib).

== Target platform: 32 bits ==

  * Install macports for your platform. Completely remove older install if present:
{{{
> sudo rm -rf \
    /opt/local \
    /Applications/DarwinPorts \
    /Applications/MacPorts \
    /Library/LaunchDaemons/org.macports.* \
    /Library/Receipts/DarwinPorts*.pkg \
    /Library/Receipts/MacPorts*.pkg \
    /Library/StartupItems/DarwinPortsStartup \
    /Library/Tcl/darwinports1.0 \
    /Library/Tcl/macports1.0 \
    ~/.macports
}}}
  * Edit _/opt/local/share/macports/Tcl/port1.0/portconfigure.tcl_ and replace the line:
{{{
default configure.ldflags   {-L${prefix}/lib}
}}}
  with:
{{{
default configure.ldflags   {"-L${prefix}/lib -Xlinker -headerpad_max_install_names"}
}}}
this will allow later to replace the absolute dependency paths in the _.dylib_ and _.so_ files by relative paths.
  * Use the portfiles included in the [http://code.google.com/p/ossbuild/source/browse/trunk#trunk/Main/GStreamer/MacOSX/MacPorts/repository svn] to create a local repository. Add the location of the local repository to the /opt/local/macports/source.conf file, as explained [http://guide.macports.org/#development.local-repositories here].
  * Add the line:
{{{
build_arch  i386
}}}
  to _/opt/local/etc/macports/macports.conf_.
  * Install the gstreamer, gst-plugins-base, gst-plugins-good, gst-plugins-bad and gst-plugins-ugly packages:
{{{
> sudo port install gstreamer
> sudo port install gst-plugins-base +no_x11 +no_gnome_vfs
> sudo port install gst-plugins-good
> sudo port install gst-plugins-bad +no_x11 +dc1394
> sudo port install gst-plugins-ugly
}}}
  * Installation of gst-ffmpeg:
{{{
> sudo port install gst-ffmpeg
}}}
  will fail during the build stage, at least for version 0.10.10. Inspection of the log file will show this error:
{{{
libavcodec/cabac.h: In function ‘get_cabac_noinline’:
libavcodec/cabac.h:527: error: PIC register ‘%ebx’ clobbered in ‘asm’
libavcodec/cabac.h: In function ‘decode_cabac_mb_intra4x4_pred_mode’:
libavcodec/cabac.h:527: error: PIC register ‘%ebx’ clobbered in ‘asm’
libavcodec/cabac.h:527: error: PIC register ‘%ebx’ clobbered in ‘asm’
libavcodec/cabac.h:527: error: PIC register ‘%ebx’ clobbered in ‘asm’
libavcodec/cabac.h:527: error: PIC register ‘%ebx’ clobbered in ‘asm’
libavcodec/cabac.h: In function ‘decode_cabac_mb_ref’:
libavcodec/cabac.h:527: error: PIC register ‘%ebx’ clobbered in ‘asm’
libavcodec/cabac.h: In function ‘decode_cabac_mb_mvd’:
libavcodec/cabac.h:527: error: PIC register ‘%ebx’ clobbered in ‘asm’
libavcodec/cabac.h:527: error: PIC register ‘%ebx’ clobbered in ‘asm’
libavcodec/cabac.h:641: error: PIC register ‘%ebx’ clobbered in ‘asm’
}}}
  Change into the _<local repository>/gnome/gst-ffmpeg/work/gst-ffmpeg-0.10.10_ folder.
   # Edit _gst-libs/ext/ffmpeg/config.h_ and make sure that the macro HAVE_EBX_AVAILABLE is defined as zero:
{{{
#define HAVE_EBX_AVAILABLE 0
}}}
   # Add the following macro definition:
{{{
#define HAVE_MMX 0
}}}
   to _gst-libs/ext/ffmpeg/libswscale/rgb2rgb_template.c_. 
These workarounds were found in [https://trac.macports.org/ticket/24636 this] bug report.
  * Still in _<local repository>/gnome/gst-ffmpeg/work/gst-ffmpeg-0.10.10_ run:
{{{
> sudo make
}}}
  followed by:
{{{
> sudo make install
}}}
  to manually complete the compilation and installation of gst-ffmpeg.

=== Compiling on a different platform ===

The steps above assume that you are compiling GStreamer on the same platform as the target. But if you are compiling from Snow Leopard (10.6) with the intention to generate binaries for Leopard (10.5), then you need to do a few additional things:
  * In _/opt/local/share/macports/Tcl/port1.0/portconfigure.tcl_ have two more linker flags added to the defaults:
{{{
default configure.ldflags   {"-L${prefix}/lib -Xlinker -headerpad_max_install_names -mmacosx-version-min=10.5 -no_compact_linkedit"}
}}}
  (Based on [http://lists.apple.com/archives/xcode-users/2009/Oct/msg00514.html this] discussion).
  * Add the following line:
{{{
macosx_deployment_target 10.5
}}}
  to _/opt/local/etc/macports/macports.conf_. For more details, see [http://lists.macosforge.org/pipermail/macports-users/2010-September/021861.html here] and [http://lists.macosforge.org/pipermail/macports-users/2010-October/022126.html here].

== Additional steps to create GStreamer binaries for bundling with 3rd-party applications ==

  * You only need _/opt/local/lib_, copy somewhere else.
  * Remove _.la_, _.a_ files.
  * Remove all subfolders, with the exception of _/lib/gstreamer-0.10_ (containing the plugins).
  * Any other file that is not _.dylib_ in _/lib_ or _.so_ in _lib/gstreamer-0.10_ can be removed as well.
  * Replace absolute paths with relative paths using the _replacepath.py_ tool.
   # For base libs:
{{{
> ./replacepath.py --old /opt/local/lib/ --new @loader_path/ --dir <lib folder>
}}}
   # For plugins (note that here we use the relative path _@loader_path/../_ instead of _@loader_path/_):
{{{
> ./replacepath.py --old /opt/local/lib/ --new @loader_path/../ --dir <lib folder>/gstreamer-0.10
}}}
  * If also needed, eliminate symbolic links using the _removesymlinks.py_ tool:
{{{
> ./removesymlinks.py --dir <lib folder>
}}}
The _replacepath.py_ and _removesymlinks.py_ tools are located in the ossbuild source trunk [http://code.google.com/p/ossbuild/source/browse/trunk#trunk/Main/GStreamer/MacOSX/MacPorts here].